@page "/"
@namespace PalaceServer.Pages
@using System.Security.Claims
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies

@inject PalaceServer.Services.AdminLoginContext LoginContext

@{
    Layout = "_Layout";

    if (!User.Identity.IsAuthenticated)
    {
        var tokenParam = $"{HttpContext.Request.Query["Token"]}";
        if (!string.IsNullOrWhiteSpace(tokenParam))
        {
            Guid.TryParse(tokenParam, out Guid token);

            if (token != Guid.Empty && LoginContext.Contains(token))
            {
                LoginContext.Remove(token);
                var claims = new List<Claim>();
                claims.Add(new Claim(ClaimTypes.NameIdentifier, ClaimValueTypes.String, $"{Guid.NewGuid()}"));
                claims.Add(new Claim(ClaimTypes.Role, "admin"));

                var claimsIdentity = new ClaimsIdentity(
                    claims, CookieAuthenticationDefaults.AuthenticationScheme);

                var userPrincipal = new ClaimsPrincipal(claimsIdentity);

                var authProperties = new AuthenticationProperties
                        {
                            AllowRefresh = true,
                            IsPersistent = true,
                        };

                await HttpContext.SignInAsync(
                    CookieAuthenticationDefaults.AuthenticationScheme,
                    userPrincipal,
                    authProperties);
            }

        }
    }

}

<component type="typeof(App)" render-mode="ServerPrerendered" />